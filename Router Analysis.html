<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<title>Auto Network Topology</title>

<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://unpkg.com/cytoscape@3.26.0/dist/cytoscape.min.js"></script>
<script src="topology.js"></script>

<style>
html,body{margin:0;height:100%;background:#0b1220;color:#e5e7eb;font-family:Arial}
#header{padding:12px 20px;background:#020617;display:flex;gap:10px}
#header input{padding:6px;background:#020617;border:1px solid #334155;color:#fff}
#header button{padding:6px 14px;border:none;font-weight:bold;color:#fff}
#btnAnalyze{background:#2563eb}
#lldp{padding:10px;border-bottom:1px solid #1e293b}
.container{
  display:flex;
  flex-direction:column;
  height:calc(100% - 110px)
}
.box{
  flex:1;
  border-top:1px solid #1e293b;
}
.cy{width:100%;height:100%}
</style>
</head>

<body>

<div id="header">
  <strong>ME Target</strong>
  <input id="target"/>
  <button id="btnAnalyze">Analyzing</button>
</div>

<div id="lldp"></div>

<div class="container">
  <div class="box"><div id="cy1" class="cy"></div></div>
  <div class="box"><div id="cy2" class="cy"></div></div>
</div>

<script>
let cyPrimary = null;
let cyBackup = null;

function render(containerId, data){
  if(!data || !data.nodes) return;

  const container = document.getElementById(containerId);

  if(container._cy){
    container._cy.destroy();
  }

  const elements = [];
  const grouped = {};

  data.nodes.forEach(n=>{
    if(grouped[n.level] === undefined) grouped[n.level] = [];
    grouped[n.level].push(n);
  });

  Object.keys(grouped).forEach(level=>{
    grouped[level].forEach((n,i)=>{
      elements.push({
        data:{ id:n.id },
        position:{
          x: level * 260 + 120,
          y: i * 150 + 120
        },
        classes: n.type === "CORE" ? "core" : "router"
      });
    });
  });

  data.edges.forEach(e=>{
    elements.push({
      data:{
        id: e.source + "_" + e.target,
        source: e.source,
        target: e.target
      }
    });
  });

  const cy = cytoscape({
    container,
    elements,
    layout:{ name:"preset" },
    style:[
      {
        selector:"node",
        style:{
          label:"data(id)",
          color:"#fff",
          "text-valign":"top",
          "text-margin-y":-10,
          "background-color":"#2563eb",
          width:60,
          height:60
        }
      },
      { selector:".core", style:{ width:80, height:80 }},

      /* ===== FIX: ACTIVE STATE ===== */
      {
        selector:"node.active",
        style:{ "background-color":"#dc2626" }
      },
      {
        selector:"edge",
        style:{ "line-color":"#9ca3af", width:4 }
      },
      {
        selector:"edge.active",
        style:{ "line-color":"#dc2626", width:6 }
      }
    ]
  });

  /* ===== FIX: CLICK TOGGLE ===== */
  cy.on("tap", "node", e=>{
    e.target.toggleClass("active");
  });

  cy.on("tap", "edge", e=>{
    e.target.toggleClass("active");
  });

  container._cy = cy;
}

btnAnalyze.onclick = async ()=>{
  const t = target.value.trim();
  if(!t) return;

  const res = await analyzePrimary(t);

  render("cy1", res.topo);

  document.getElementById("lldp").innerHTML =
    "LLDP: " + res.lldp.map(n =>
      `<button onclick="loadVia('${t}','${n}')">${n}</button>`
    ).join(" ");
};

async function loadVia(t, via){
  const topo = await analyzeVia(t, via);
  render("cy2", topo);
}
</script>

</body>
</html>
